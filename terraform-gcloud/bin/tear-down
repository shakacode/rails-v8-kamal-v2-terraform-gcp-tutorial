#!/bin/bash

set -e

# This script stops the Kamal app and destroys the Terraform infrastructure.
# By default, all resources including the static IP are destroyed (no lingering costs).
# Use --keep-ip to preserve the static IP so DNS and deploy.yml stay stable
# across destroy/apply cycles (~$0.01/hr while not attached to a running VM).
#
# It should be run from any directory, as it calculates paths relative to the script's location.

pushd . > /dev/null

# Get the directory of the script
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

KEEP_IP=false
for arg in "$@"; do
  case $arg in
    --keep-ip)
      KEEP_IP=true
      ;;
  esac
done

echo "$SCRIPT_DIR is the script directory"

echo "Stopping the Kamal app..."
cd "$SCRIPT_DIR/../.."
./bin/kamal app stop

# Destroy the Terraform infrastructure
cd "$SCRIPT_DIR/.."

if [ "$KEEP_IP" = true ]; then
  echo "Preserving static IP for next stand-up (~\$0.01/hr while unattached)..."
  terraform state rm google_compute_address.rails_app_ip 2>/dev/null || true
fi

echo "Destroying the Terraform infrastructure..."
terraform destroy -auto-approve

echo "Completed destroying the Terraform infrastructure..."

popd > /dev/null
